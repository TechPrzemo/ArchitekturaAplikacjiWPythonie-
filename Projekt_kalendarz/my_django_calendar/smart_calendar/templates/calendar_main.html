{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Calendar Main</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles_calendar.css' %}">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            const prevButton = document.getElementById('prev-month');
            const nextButton = document.getElementById('next-month');
            const monthYearDisplay = document.getElementById('month-year');
            const calendarDays = document.getElementById('calendar-days');
            const eventsContainer = document.getElementById('events-container');

            let currentMonth = {{ month }};
            let currentYear = {{ year }};

            function updateCalendar(month, year) {
                fetch(`/get_calendar_days/?month=${month}&year=${year}`)
                    .then(response => response.json())
                    .then(data => {
                        calendarDays.innerHTML = '';
                        eventsContainer.innerHTML = '';
                        data.days.forEach(day => {
                            const dayElement = document.createElement('div');
                            dayElement.textContent = day.day;
                            calendarDays.appendChild(dayElement);
                        });
                        monthYearDisplay.textContent = `${data.month} ${data.year}`;
                        
                        data.events.forEach(event => {
                            const eventElement = document.createElement('div');
                            eventElement.innerHTML = `<strong>${event.title}</strong>: ${JSON.stringify(event, null, 2)}
                            <a href=" " class="delete-event" data-id='${ event.event_id }'>Delete</a>`;
                            eventsContainer.appendChild(eventElement);
                        });
                    });
            }

            prevButton.addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 1) {
                    currentMonth = 12;
                    currentYear--;
                }
                updateCalendar(currentMonth, currentYear);
            });

            nextButton.addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
                updateCalendar(currentMonth, currentYear);
            });

            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('delete-event')) {
                    event.preventDefault();
                    
                    const event_id = event.target.getAttribute('data-id');
                    console.log("event_id:", event_id);

                    if (event_id){
                    if (confirm('Are you sure you want to delete this event?')) {
                        fetch(`/del_event/${event_id}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken, // Przekazanie tokena CSRF
                                'Content-Type': 'application/json'
                            },
                        }).then(response => {
                            if (response.ok) {
                                event.target.parentElement.remove(); // UsuniÄ™cie elementu z DOM
                            } else {
                                alert('Failed to delete event.');
                                console.log(event.event_id)
                            }
                        }).catch(error => {
                            alert(`Error: ${error.message}`);
                        });
                    
                } else if (!event_id) {
                    alert('Event ID is undefined!');
                }
            }
        }
        });

            updateCalendar(currentMonth, currentYear);
        });
    </script>
</head>
<body>
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <div class="calendar-container">
        <div class="month-nav">
            <button id="prev-month">Previous</button>
            <span id="month-year">{{ month }} {{ year }}</span>
            <button id="next-month">Next</button>
        </div>
        <div class="calendar">
            <div class="day-header">
                <div>Monday</div>
                <div>Tuesday</div>
                <div>Wednesday</div>
                <div>Thursday</div>
                <div>Friday</div>
                <div>Saturday</div>
                <div>Sunday</div>
            </div>
            <div id="calendar-days" class="days"></div>
        </div>
        <div id="events-container">
            {% for event in events %}
            <div>
                <strong>{{ event.title }}</strong>: ({{ event }})
                <a href="#" class="delete-event" data-id="{{ event.event_id }}">Delete</a>

            </div>
            {% endfor %}    
        </div>
        <div>
            <a href="{% url 'add_event' %}">Add Event</a>
        </div>
    </div>
</body>
</html>
